<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Blood Diagnosis Tool</title>
    
    <!-- Import Work Sans font -->
    <link href="https://fonts.googleapis.com/css2?family=Work+Sans:ital,wght@0,100..900;1,100..900&display=swap" rel="stylesheet">
    
    <style>
        /* CSS Variables for Color Palette */
        :root {
            /* Primary Colors */
            --color-primary: #19B76A;
            --color-primary-dark: #16A085;
            
            /* Background Colors */
            --bg-main: linear-gradient(180deg, #BFC3C8 0%, #DAD9DA 100%);
            --bg-container: #F8F8F8;
            --bg-left-top: rgba(245, 245, 245, 0.9);
            --bg-left-bottom: rgba(255, 255, 255, 0.9);
            --bg-input: rgba(255, 255, 255, 0.95);
            
            /* Text Colors */
            --text-primary: #202020;
            --text-secondary: #343434;
            --text-muted: #6B7280;
            --text-placeholder: #9CA3AF;
            --text-disabled: #D1D5DB;
            
            /* Border Colors */
            --border-light: #EAEAEA;
            --border-medium: #E5E7EB;
            --border-glass: rgba(255, 255, 255, 0.3);
            
            /* Shadow Colors */
            --shadow-subtle: 0 4px 16px rgba(0, 0, 0, 0.05);
            --shadow-medium: 0 4px 16px rgba(0, 0, 0, 0.08);
            --shadow-strong: 0 8px 32px rgba(0, 0, 0, 0.1);
            --shadow-inset: inset 0 1px 0 rgba(255, 255, 255, 0.6);
            
            /* Avatar Colors */
            --avatar-bg: #dbdbdb;
        }

        /* Reset all default styles */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        html, body {
            margin: 0;
            padding: 0;
            width: 100%;
            height: 100%;
            overflow: hidden;
            font-family: 'Work Sans', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: var(--bg-main);
        }

        /* Main page container */
        .main-container {
            display: flex;
            width: 100vw;
            height: 100vh;
            min-height: 100vh;
            max-height: 100vh;
            background: var(--bg-main);
            padding: 16px;
            gap: 16px;
        }

        /* Left container - Chat history */
        .left-container {
            flex: 0 0 330px;
            display: flex;
            flex-direction: column;
            background: color(srgb 0.95 0.95 0.95 / 0.8);
            border-radius: 16px;
            box-shadow: var(--shadow-medium);
            overflow: hidden;
        }

        .top-container {
            flex: 1;
            display: flex;
            flex-direction: column;
            /* background: var(--bg-left-top); */
            padding: 0;
            overflow-y: auto;
            scrollbar-width: none; /* Firefox */
            -ms-overflow-style: none; /* Internet Explorer 10+ */
        }

        .top-container::-webkit-scrollbar {
            display: none; /* WebKit */
        }

        .section-header {
            position: sticky;
            top: 0;
            z-index: 10;
            padding: 20px;
            background: color(srgb 0.95 0.95 0.95 / 1.0);
            border-bottom: 1px solid rgba(32, 32, 32, 0.094);
        }

        .section-title {
            font-size: 14px;
            text-transform: uppercase;
            font-weight: 600;
            color: var(--text-primary);
        }

        .chat-history {
            flex: 1;
            display: flex;
            flex-direction: column;
        }


        .chat-item {
            transition: all 0.3s ease;
            cursor: pointer;
            padding: 20px;
            border-bottom: 1px solid #d4d4d47a;
        }

        .chat-item:hover {
            background: #f5f5f5;
            transform: translateX(2px);
        }

        .chat-item.active {
            background: #f2f2f2;
            /* border-right: 1px solid var(--color-primary); */
        }


        .special-item {
            background: linear-gradient(135deg, #19B76A, #16A085);
            color: white;
            border-radius: 12px;
            margin-bottom: 8px;
            border: none;
        }

        .special-item .chat-date {
            color: rgba(255, 255, 255, 0.9);
            font-weight: 600;
        }

        .special-item .chat-message {
            color: rgba(255, 255, 255, 0.8);
        }

        .special-item:hover {
            background: linear-gradient(135deg, #16A085, #138D75);
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(25, 183, 106, 0.3);
        }

        .chat-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 6px;
        }

        .chat-date {
            font-size: 12px;
            font-weight: 500;
            color: var(--text-muted);
        }

        .chat-time {
            font-size: 12px;
            color: var(--text-muted);
        }

        .chat-message {
            font-size: 14px;
            color: var(--text-secondary);
            line-height: 1.4;
        }

        .bottom-container {
            /* background: var(--bg-left-bottom); */
            padding: 20px;
            border-top: 1px solid #c6c6c6;
        }

        .user-profile {
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .user-avatar-container {
            width: 40px;
            height: 40px;
            border-radius: 8px;
            background: var(--avatar-bg);
            display: flex;
            align-items: center;
            justify-content: center;
            overflow: hidden;
        }

        .user-info {
            flex: 1;
        }

        .user-name {
            font-size: 14px;
            font-weight: 600;
            color: var(--text-primary);
            margin-bottom: 2px;
        }

        .user-role {
            font-size: 12px;
            color: var(--text-muted);
        }

        /* Right container - Chat interface */
        .right-container {
            flex: 1;
            display: flex;
            flex-direction: column;
            align-items: center;
            background: #f3f3f3;
            border-radius: 16px;
            box-shadow: var(--shadow-medium);
            overflow: visible;
        }

        .right-top-container {
            flex: 1;
            display: flex;
            flex-direction: column;
            padding: 20px;
            position: relative;
            width: 100%;
            max-width: 800px;
            overflow-y: auto;
        }

        .chat-container {
            display: flex;
            flex-direction: column;
            min-height: 100%;
            position: relative;
        }

        .welcome-section {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            text-align: center;
            height: 100%;
            transition: all 0.3s ease;
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
        }

        .welcome-section svg {
            margin-bottom: 20px;
        }

        .welcome-section p {
            font-size: 18px;
            color: var(--text-secondary);
            line-height: 1.5;
        }

        .chat-conversation {
            display: none;
            flex-direction: column;
            gap: 8px;
            /* padding: 10px 0; */
            height: 100%;
            overflow-y: auto;
            /* min-height: 0; */
            scrollbar-width: none; /* Firefox */
            -ms-overflow-style: none; /* Internet Explorer 10+ */
        }

        .chat-conversation::-webkit-scrollbar {
            display: none; /* WebKit */
        }

        .chat-conversation.active {
            display: flex;
        }

        .message {
            display: flex;
            flex-direction: column;
            max-width: 80%;
            animation: slideInUp 0.3s ease;
            margin: 8px 0;
        }

        .message.user {
            align-self: flex-end;
        }

        .message.assistant {
            align-self: flex-start;
        }

        .message-bubble {
            padding: 16px;
            border-radius: 18px;
            font-size: 14px;
            line-height: 1.4;
            word-wrap: break-word;
            background: #ffffff;
            color: #2c2c2c;
            border: none;
        }

        .message.user .message-bubble {
            background: #fff;
            color: #2c2c2c;
            border: none;
        }


        .medical-data {
            background: #ffffff8c;
            border-radius: 12px;
            padding: 20px;
            /* margin: 20px 0; */
            max-height: none;
            overflow-y: visible;
            scrollbar-width: thin;
            -ms-overflow-style: auto;
        }

        .medical-data::-webkit-scrollbar {
            width: 6px;
        }

        .medical-data::-webkit-scrollbar-track {
            background: transparent;
        }

        .medical-data::-webkit-scrollbar-thumb {
            background: #D1D5DB;
            border-radius: 3px;
        }

        .medical-data::-webkit-scrollbar-thumb:hover {
            background: #9CA3AF;
        }

        .medical-message {
            margin: 0;
            padding: 0;
        }

        .medical-message:last-child {
            margin-bottom: 0;
        }

        .right-top-container::-webkit-scrollbar {
            width: 6px;
        }

        .right-top-container::-webkit-scrollbar-thumb {
            background: #D1D5DB;
            border-radius: 3px;
        }

        .right-top-container::-webkit-scrollbar-track {
            background: transparent;
        }

        .right-top-container::-webkit-scrollbar-thumb:hover {
            background: #9CA3AF;
        }

        .patient-card {
            background: white;
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 20px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
        }

        .patient-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 16px;
        }

        .patient-info {
            display: flex;
            flex-direction: column;
            gap: 8px;
            margin-bottom: 16px;
        }

        .info-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 8px 0;
            border-bottom: 1px solid #d4d4d47a;
        }

        .info-row:last-child {
            border-bottom: none;
        }

        .info-label {
            font-weight: 600;
            color: #64748b;
            font-size: 14px;
            min-width: 100px;
        }

        .info-value {
            color: #1e293b;
            font-size: 14px;
            text-align: right;
        }

        .patient-avatar {
            width: 48px;
            height: 48px;
            background: #E3F2FD;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .patient-details h3 {
            margin: 0 0 8px 0;
            font-size: 20px;
            font-weight: 600;
            color: #1F2937;
        }

        .patient-meta {
            display: flex;
            gap: 16px;
            font-size: 14px;
            color: #6B7280;
        }

        .patient-gender {
            background: #DBEAFE;
            color: #1E40AF;
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 500;
        }

        .abnormal-count {
            color: #dc2626;
            font-weight: 500;
            font-size: 14px;
            margin-left: 8px;
        }

        .lab-results {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 12px;
            margin-bottom: 20px;
        }

        @media (max-width: 768px) {
            .lab-results {
                grid-template-columns: repeat(2, 1fr);
            }
        }

        @media (max-width: 480px) {
            .lab-results {
                grid-template-columns: 1fr;
            }
        }

        .lab-header {
            border-bottom: 1px solid #E5E7EB;
            padding-bottom: 16px;
            margin-bottom: 20px;
        }

        .lab-header h3 {
            margin: 0 0 8px 0;
            font-size: 18px;
            font-weight: 600;
            color: #1F2937;
        }

        .lab-summary {
            font-size: 14px;
            color: #EF4444;
            font-weight: 500;
        }

        .lab-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 1px;
            background: #E5E7EB;
            border-radius: 8px;
            overflow: hidden;
        }

        .lab-item {
            background: white;
            padding: 16px;
            display: flex;
            align-items: center;
            justify-content: space-between;
        }

        .lab-item-left {
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .lab-item-right {
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .lab-name {
            font-weight: 500;
            color: #1F2937;
            margin-bottom: 4px;
        }

        .lab-normal {
            font-size: 12px;
            color: #6B7280;
        }

        .lab-value {
            font-weight: 600;
            font-size: 16px;
        }

        .lab-value.high {
            color: #EF4444;
        }

        .lab-value.low {
            color: #EF4444;
        }

        .lab-severity {
            padding: 4px 8px;
            border-radius: 12px;
            font-size: 12px;
            font-weight: 500;
        }

        .severity-severe {
            background: #FEE2E2;
            color: #DC2626;
        }

        .severity-moderate {
            background: #FEF3C7;
            color: #D97706;
        }

        .severity-mild {
            background: #FEF3C7;
            color: #D97706;
        }

        .diagnosis-section {
            background: white;
            border-radius: 12px;
            padding: 20px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
        }

        .diagnosis-header {
            background: transparent;
            color: var(--text-primary);
            padding: 0;
            border-radius: 0;
            margin: 0 0 16px 0;
            border-bottom: 1px solid var(--border-light);
        }

        .diagnosis-header h3 {
            margin: 0 0 8px 0;
            font-size: 20px;
            font-weight: 600;
        }

        .diagnosis-description {
            font-size: 14px;
            opacity: 0.9;
        }

        .diagnosis-grid {
            display: grid;
            gap: 16px;
        }

        .diagnosis-card {
            border: 1px solid #E5E7EB;
            border-radius: 12px;
            padding: 20px;
            position: relative;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .diagnosis-card:hover {
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
            transform: translateY(-2px);
        }

        .diagnosis-rank {
            position: absolute;
            top: -8px;
            left: 20px;
            background: #19B76A;
            color: white;
            width: 24px;
            height: 24px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 600;
            font-size: 12px;
        }

        .diagnosis-confidence {
            display: flex;
            align-items: center;
            gap: 8px;
            margin-bottom: 12px;
        }

        .confidence-score {
            font-size: 24px;
            font-weight: 700;
            color: #19B76A;
        }

        .confidence-label {
            font-size: 12px;
            color: #6B7280;
        }

        .diagnosis-name {
            font-size: 18px;
            font-weight: 600;
            color: #1F2937;
            margin-bottom: 12px;
        }

        .diagnosis-reasoning {
            font-size: 14px;
            color: #6B7280;
            line-height: 1.5;
            margin-bottom: 16px;
        }

        .diagnosis-badges {
            display: flex;
            gap: 8px;
            flex-wrap: wrap;
        }

        .badge {
            background: linear-gradient(135deg, #dbeafe 0%, #bfdbfe 100%);
            color: #1e40af;
            padding: 6px 12px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 600;
            border: 1px solid rgba(30, 64, 175, 0.2);
            box-shadow: 0 2px 4px rgba(30, 64, 175, 0.1);
            transition: all 0.3s ease;
        }

        .badge:hover {
            transform: translateY(-1px);
            box-shadow: 0 4px 8px rgba(30, 64, 175, 0.15);
        }

        .analyzing-text {
            display: flex;
            align-items: center;
            gap: 8px;
            color: #64748b;
            font-size: 14px;
            font-weight: 500;
        }

        .processing-dots {
            display: flex;
            gap: 4px;
        }

        .dot {
            width: 6px;
            height: 6px;
            background: #19b76a;
            border-radius: 50%;
            animation: processingDots 1.2s infinite ease-in-out both;
        }

        .dot:nth-child(1) {
            animation-delay: -0.32s;
        }

        .dot:nth-child(2) {
            animation-delay: -0.16s;
        }

        .dot:nth-child(3) {
            animation-delay: 0s;
        }

        @keyframes processingDots {
            0%, 80%, 100% {
                transform: scale(0.8);
                opacity: 0.5;
            }
            40% {
                transform: scale(1.2);
                opacity: 1;
            }
        }

        .pdf-document-card {
            /* background: #1e293b; */
            /* border: 1px solid #334155; */
            /* border-radius: 12px; */
            /* padding: 16px; */
            max-width: 280px;
            /* transition: all 0.2s ease; */
        }

        .pdf-file-name {
            color: #2c2c2d;
            font-size: 14px;
            font-weight: 400;
            margin-bottom: 12px;
            word-break: break-word;
        }

        .pdf-icon-container {
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .pdf-icon {
            background: #dc2626;
            color: white;
            font-size: 12px;
            font-weight: 700;
            padding: 8px 12px;
            border-radius: 6px;
            letter-spacing: 0.5px;
        }

        .pdf-type {
            color: #94a3b8;
            font-size: 14px;
            font-weight: 500;
        }

        /* Detailed Diagnosis Chat - Minimal Design */
        .detailed-diagnosis {
            background: transparent;
            border-radius: 0;
            padding: 0;
            margin: 8px 0;
            border: none;
        }

        .detailed-diagnosis .diagnosis-header {
            text-align: left;
            padding: 0 0 12px 0;
            margin-bottom: 16px;
            border-bottom: 1px solid var(--border-light);
        }

        .diagnosis-rank-circle {
            display: flex;
            align-items: center;
            gap: 8px;
            margin-bottom: 8px;
        }

        .rank-number {
            width: 20px;
            height: 20px;
            background: #19b76a;
            color: white;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 600;
            font-size: 12px;
        }

        .detailed-diagnosis .diagnosis-title {
            font-size: 18px;
            font-weight: 600;
            color: var(--text-primary);
            margin: 0;
        }

        .detailed-diagnosis .confidence-badge {
            display: inline-block;
            background: var(--bg-input);
            color: var(--text-muted);
            padding: 4px 8px;
            border-radius: 6px;
            font-weight: 500;
            font-size: 12px;
            margin-bottom: 8px;
            border: 1px solid var(--border-light);
        }

        .progress-wrapper {
            background: transparent;
            border-radius: 0;
            padding: 0;
            margin-bottom: 8px;
        }

        .progress-label {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 4px;
        }

        .progress-label-text {
            font-weight: 500;
            color: #64748b;
            font-size: 12px;
        }

        .progress-label-value {
            font-weight: 600;
            color: #19b76a;
            font-size: 12px;
        }

        .detailed-diagnosis .progress-bar-container {
            width: 100%;
            height: 6px;
            background: var(--border-light);
            border-radius: 3px;
            overflow: hidden;
        }

        .detailed-diagnosis .progress-bar {
            height: 100%;
            background: var(--color-primary);
            border-radius: 3px;
            transition: width 0.3s ease;
        }

        .detailed-diagnosis .diagnosis-description {
            color: var(--text-secondary);
            font-size: 14px;
            line-height: 1.5;
            margin: 0;
        }

        .diagnosis-details {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        .detail-section {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        .detailed-diagnosis .detail-card {
            background: var(--bg-input);
            border: 1px solid var(--border-light);
            border-radius: 8px;
            padding: 16px;
            margin-bottom: 12px;
        }

        .detailed-diagnosis .detail-card.danger {
            /* border-left: 3px solid #dc2626; */
            /* background: #fef2f2; */
        }

        .detailed-diagnosis .detail-card.success {
            /* border-left: 3px solid #059669; */
            /* background: #f0fdf4; */
        }

        .card-header {
            display: flex;
            align-items: center;
            margin-bottom: 4px;
        }

        .card-icon {
            width: 12px;
            height: 12px;
            margin-right: 6px;
        }

        .detailed-diagnosis .card-title {
            font-size: 14px;
            font-weight: 600;
            color: var(--text-primary);
            margin: 0;
        }

        .detailed-diagnosis .card-title.danger {
            color: #dc2626;
        }

        .detailed-diagnosis .card-title.success {
            color: #059669;
        }

        .badge-container {
            display: flex;
            flex-wrap: wrap;
            gap: 3px;
        }

        .detailed-diagnosis .badge {
            background: var(--bg-container);
            color: var(--text-muted);
            padding: 4px 8px;
            border-radius: 6px;
            font-size: 11px;
            font-weight: 500;
            border: 1px solid var(--border-light);
        }

        .detailed-diagnosis .red-flag-item {
            display: flex;
            align-items: center;
            gap: 8px;
            background: transparent;
            border-radius: 0;
            padding: 4px 0;
        }

        .detailed-diagnosis .red-flag-dot {
            width: 8px;
            height: 8px;
            background: #dc2626;
            border-radius: 50%;
            flex-shrink: 0;
        }

        .detailed-diagnosis .red-flag-text {
            color: #dc2626;
            font-weight: 500;
            font-size: 12px;
        }

        .detailed-diagnosis .step-item {
            display: flex;
            align-items: flex-start;
            gap: 8px;
            background: transparent;
            border-radius: 0;
            padding: 4px 0;
        }

        .detailed-diagnosis .step-number {
            width: 20px;
            height: 20px;
            background: var(--bg-container);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            flex-shrink: 0;
            margin-top: 1px;
            border: 1px solid var(--border-light);
        }

        .detailed-diagnosis .step-number span {
            font-weight: 600;
            color: var(--text-muted);
            font-size: 11px;
        }

        .detailed-diagnosis .step-text {
            color: var(--text-secondary);
            line-height: 1.4;
            font-weight: 500;
            font-size: 12px;
        }

        .detailed-diagnosis .evidence-section {
            margin-top: 16px;
        }

        .detailed-diagnosis .evidence-grid {
            display: flex;
            flex-direction: column;
            gap: 12px;
        }

        .detailed-diagnosis .evidence-card {
            background: var(--bg-input);
            border: 1px solid var(--border-light);
            border-radius: 8px;
            padding: 16px;
            transition: all 0.2s ease;
        }

        .detailed-diagnosis .evidence-card:hover {
            border-color: var(--color-primary);
            box-shadow: 0 2px 8px rgba(25, 183, 106, 0.1);
        }

        .detailed-diagnosis .evidence-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 8px;
        }

        .detailed-diagnosis .evidence-badge {
            background: var(--bg-container);
            color: var(--text-muted);
            padding: 2px 6px;
            border-radius: 4px;
            font-size: 10px;
            font-weight: 600;
            border: 1px solid var(--border-light);
        }

        .detailed-diagnosis .evidence-title {
            font-size: 14px;
            font-weight: 600;
            color: var(--text-primary);
            margin: 0 0 4px 0;
        }

        .detailed-diagnosis .evidence-source {
            color: var(--text-muted);
            font-size: 12px;
            font-weight: 500;
        }

        .detailed-diagnosis .evidence-quote {
            color: var(--text-secondary);
            font-style: italic;
            line-height: 1.4;
            border-left: 3px solid var(--color-primary);
            padding-left: 12px;
            background: transparent;
            padding: 8px 0 8px 12px;
            border-radius: 0;
            font-size: 12px;
            margin-top: 8px;
        }


        @media (max-width: 768px) {
            .diagnosis-details {
                grid-template-columns: 1fr;
                gap: 20px;
                padding: 20px;
            }
            
            .evidence-grid {
                grid-template-columns: 1fr;
            }
            
            .diagnosis-title {
                font-size: 24px;
            }
        }

       

        .medical-message h4 {
            margin: 0 0 12px 0;
            color: #1e293b;
            font-size: 16px;
            font-weight: 600;
        }

        .patient-info-content p {
            margin: 4px 0;
            color: #475569;
            font-size: 14px;
        }

        .abnormal-count {
            color: #dc2626;
            font-weight: 600;
            font-size: 14px;
            margin-bottom: 12px;
        }

        .lab-items {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        .lab-item-result {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 8px 12px;
            background: white;
            border-radius: 8px;
            border: 1px solid #e2e8f0;
        }

        .lab-name {
            font-weight: 500;
            color: #1e293b;
            flex: 1;
        }

        .lab-value {
            font-weight: 600;
            margin-right: 12px;
        }

        .lab-value.high {
            color: #dc2626;
        }

        .lab-value.low {
            color: #dc2626;
        }

        .lab-severity {
            padding: 2px 8px;
            border-radius: 12px;
            font-size: 12px;
            font-weight: 500;
        }

        .lab-severity.severe {
            background: #fee2e2;
            color: #dc2626;
        }

        .lab-severity.moderate {
            background: #fef3c7;
            color: #d97706;
        }

        .lab-severity.mild {
            background: #fef3c7;
            color: #d97706;
        }

        .lab-item {
            display: flex;
            flex-direction: column;
            padding: 16px;
            border-radius: 8px;
            border: 1px solid rgba(0, 0, 0, 0.08);
            background: transparent;
            text-align: left;
            transition: all 0.3s ease;
            align-items: flex-start;
        }

        .lab-item:hover {
            border-color: rgba(0, 0, 0, 0.15);
            transform: translateY(-1px);
        }

        .lab-name {
            font-weight: 500;
            color: #64748b;
            font-size: 14px;
            margin-bottom: 8px;
        }

        .lab-value-container {
            display: flex;
            align-items: center;
            gap: 8px;
            margin-bottom: 4px;
        }

        .lab-value {
            font-weight: 700;
            font-size: 18px;
            color: #1e293b;
        }

        .lab-normal {
            font-size: 12px;
            color: #6b7280;
            margin-bottom: 4px;
        }

        .lab-status-icon {
            font-size: 16px;
            font-weight: bold;
        }

        .lab-status-icon.high {
            color: #dc2626;
        }

        .lab-status-icon.low {
            color: #dc2626;
        }

        .lab-status-icon.moderate {
            color: #f59e0b;
        }

        .lab-status:contains("High") {
            background: #fee2e2;
            color: #dc2626;
        }

        .lab-status:contains("Normal") {
            background: #d1fae5;
            color: #059669;
        }

        .lab-status:contains("Borderline") {
            background: #fef3c7;
            color: #d97706;
        }

        .diagnosis-item {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            padding: 12px 0;
            border-bottom: 1px solid #d4d4d47a;
        }

        .diagnosis-item:last-child {
            border-bottom: none;
        }

        .diagnosis-label {
            font-weight: 600;
            color: #64748b;
            font-size: 14px;
            min-width: 140px;
        }

        .diagnosis-value {
            color: #1e293b;
            font-size: 14px;
            text-align: right;
            flex: 1;
        }

        .diagnosis-subtitle {
            color: #64748b;
            font-size: 14px;
            margin-bottom: 16px;
        }

        .diagnosis-cards {
            display: flex;
            flex-direction: column;
            gap: 12px;
        }

        .diagnosis-cards-container {
            display: flex;
            flex-direction: column;
            gap: 8px;
            margin-top: 16px;
        }

        .diagnosis-cards-container .diagnosis-header-row {
            display: flex;
            align-items: center;
            justify-content: space-between;
            width: 100%;
            margin-bottom: 4px;
        }

        .diagnosis-cards-container .diagnosis-name {
            font-weight: 500;
            font-size: 18px;
            color: #1e293b;
            margin-bottom: 0;
            flex: 1;
        }

        .diagnosis-cards-container .diagnosis-confidence {
            display: flex;
            align-items: center;
            gap: 4px;
            margin-bottom: 0;
        }

        .diagnosis-card {
            display: flex;
            flex-direction: column;
            padding: 16px;
            border-radius: 8px;
            border: 1px solid rgba(0, 0, 0, 0.08);
            background: transparent;
            text-align: left;
            transition: all 0.3s ease;
            align-items: flex-start;
            margin-bottom: 8px;
        }

        .diagnosis-card:hover {
            border-color: rgba(0, 0, 0, 0.15);
            transform: translateY(-1px);
        }


        .diagnosis-rank {
            font-weight: 500;
            color: #64748b;
            font-size: 14px;
            margin-bottom: 8px;
        }

        .diagnosis-header-row {
            display: flex;
            align-items: center;
            justify-content: space-between;
            width: 100%;
            margin-bottom: 4px;
        }

        .diagnosis-name {
            font-weight: 500;
            font-size: 18px;
            color: #1e293b;
            margin-bottom: 0;
            flex: 1;
        }

        .diagnosis-confidence {
            display: flex;
            align-items: center;
            gap: 8px;
            margin-bottom: 4px;
        }

        .confidence-score {
            font-weight: 500;
            font-size: 18px;
            color: #1e293b;
        }

        .confidence-score.high-confidence {
            color: #dc2626;
        }

        .confidence-label {
            font-size: 12px;
            color: #6b7280;
            margin-bottom: 4px;
        }

        .diagnosis-reasoning {
            color: #64748b;
            font-size: 14px;
            margin-bottom: 8px;
        }

        .pdf-analysis {
            padding-bottom: 12px;
            border-bottom: 0.25px solid #d7d7d7;
            transition: all 0.3s ease;
            cursor: pointer;
            /* border-left: 4px solid #3b82f6; */
        }

        .pdf-analysis .chat-date {
            font-weight: 600;
        }

        @keyframes slideInUp {
            from {
                opacity: 0;
                transform: translateY(20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        /* Loading animation for API calls */
        .loading-dots {
            display: flex;
            gap: 4px;
            align-items: center;
        }

        .loading-dots span {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background-color: var(--text-primary);
            animation: loading 1.4s infinite ease-in-out both;
        }

        .loading-dots span:nth-child(1) { animation-delay: -0.32s; }
        .loading-dots span:nth-child(2) { animation-delay: -0.16s; }

        @keyframes loading {
            0%, 80%, 100% { transform: scale(0); }
            40% { transform: scale(1); }
        }

        .right-bottom-container {
            padding: 20px;
            width: 100%;
            max-width: 800px;
            position: sticky;
            bottom: 0;
            z-index: 100;
            margin: 0 auto;
            display: flex;
            justify-content: center;
        }

        .input-section {
            display: flex;
            gap: 0;
            align-items: center;
            border: 1px solid var(--border-medium);
            border-radius: 12px;
            background: #ffffff8c;
            position: relative;
            transition: all 0.3s ease;
            width: 100%;
            max-width: 800px;
        }

        .input-section:hover {
            border: 1.5px solid #cccccc;
        }

        .input-section:focus-within {
            border: 1.5px solid #cccccc;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
        }

        .input-section::before {
            content: '';
            position: absolute;
            top: -2px;
            left: -2px;
            right: -2px;
            bottom: -2px;
            background: linear-gradient(45deg, #19B76A, #16A085, #19B76A, #16A085);
            background-size: 400% 400%;
            border-radius: 14px;
            z-index: -1;
            opacity: 0;
            transition: opacity 0.3s ease;
        }


        @keyframes gradientShift {
            0% {
                background-position: 0% 50%;
            }
            50% {
                background-position: 100% 50%;
            }
            100% {
                background-position: 0% 50%;
            }
        }

        .input-field {
            flex: 1;
        }

        .message-input {
            width: 100%;
            padding: 12px 16px;
            border: none;
            background: transparent;
            font-size: 14px;
            color: var(--text-primary);
            outline: none;
        }

        .message-input::placeholder {
            color: var(--text-placeholder);
        }

        .button-group {
            display: flex;
        }

        .pdf-btn, .send-btn {
            width: 44px;
            height: 44px;
            border: none;
            background: transparent;
            color: var(--text-muted);
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .pdf-btn {
            border-right: 1px solid var(--border-medium);
        }

        .pdf-btn:hover, .send-btn:hover {
            /* background: rgba(25, 183, 106, 0.1); */
            color: var(--color-primary);
        }

        /* Custom scrollbar for main container */
        .main-container::-webkit-scrollbar {
            width: 3px;
        }

        .main-container::-webkit-scrollbar-track {
            background: transparent;
        }

        .main-container::-webkit-scrollbar-thumb {
            background: #E5E7EB;
            border-radius: 1.5px;
            transition: all 0.3s ease;
        }

        .main-container::-webkit-scrollbar-thumb:hover {
            background: #D1D5DB;
            width: 4px;
        }

        .main-container {
            scrollbar-width: thin;
            scrollbar-color: #E5E7EB transparent;
        }

        /* Global scrollbar customization */
        ::-webkit-scrollbar {
            width: 6px;
        }

        ::-webkit-scrollbar-track {
            background: transparent;
        }

        ::-webkit-scrollbar-thumb {
            background: #D1D5DB;
            border-radius: 3px;
            transition: all 0.3s ease;
        }

        ::-webkit-scrollbar-thumb:hover {
            background: #9CA3AF;
        }

        /* Mobile and tablet responsive design */
        @media (max-width: 1024px) {
            .main-container {
                flex-direction: column;
                height: 100vh;
                min-height: 100vh;
                max-height: 100vh;
                padding: 12px;
            }

            .left-container {
                flex: 0 0 200px;
            }

            .right-container {
                flex: 1;
                min-width: 0;
            }
        }

        @media (max-width: 768px) {
            .main-container {
                padding: 8px;
                gap: 8px;
            }
            
            .left-container {
                flex: 0 0 180px;
            }
            
            .top-container {
                padding: 16px;
            }
            
            .right-top-container {
                padding: 20px;
            }
            
            .right-top-container p {
                font-size: 16px;
            }
        }

        @media (max-width: 480px) {
            .main-container {
                padding: 4px;
                gap: 4px;
            }
            
            .left-container {
                flex: 0 0 160px;
            }
            
            .top-container {
                padding: 12px;
            }
            
            .right-top-container {
                padding: 16px;
            }
            
            .right-top-container p {
                font-size: 14px;
            }
            
            .input-section {
                gap: 8px;
            }
            
            .message-input {
                padding: 10px 12px;
                font-size: 13px;
            }
            
            .send-btn {
                width: 40px;
                height: 40px;
            }
        }

        /* Landscape orientation for tablets */
        @media (max-height: 600px) and (orientation: landscape) {
            .main-container {
                flex-direction: row;
                padding: 8px;
                gap: 8px;
            }
            
            .left-container {
                flex: 0 0 300px;
            }
            
            .right-container {
                flex: 1;
            }
        }

        /* Touch device optimizations */
        @media (hover: none) and (pointer: coarse) {
            .chat-item:hover {
                transform: none;
            }
            
            .send-btn:hover {
                transform: none;
            }
            
            .message-input:focus {
                -webkit-tap-highlight-color: transparent;
            }
        }

        /* Connection status indicator */
        .connection-status {
            position: fixed;
            top: 20px;
            left: 20px;
            padding: 8px 12px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 500;
            z-index: 1000;
            transition: all 0.3s ease;
        }

        .connection-status.connected {
            background: #d1fae5;
            color: #059669;
            border: 1px solid #a7f3d0;
        }

        .connection-status.disconnected {
            background: #fee2e2;
            color: #dc2626;
            border: 1px solid #fecaca;
        }

        .connection-status.unknown {
            background: #fef3c7;
            color: #d97706;
            border: 1px solid #fde68a;
        }
    </style>
</head>
<body>
    <!-- Connection Status Indicator -->
    <div id="connectionStatus" class="connection-status unknown">Connecting...</div>
    
    <div class="main-container">
        <div class="left-container">
            <div class="top-container">
                <div class="section-header">
                    <span class="section-title">Previous Diagnosis</span>
                </div>
                <div class="chat-history">
                    <!-- Chat items will be added dynamically -->
                </div>
            </div>
            <div class="bottom-container">
                <div class="user-profile">
                    <div class="user-avatar-container">
                        <img src="https://encrypted-tbn0.gstatic.com/images?q=tbn:ANd9GcRT7ZW1MttWL5hg-E0pJuXIftWMBhUpcifEsA&s" alt="Mihir Shah" style="width: 100%; height: 100%; border-radius: 8px; object-fit: cover;">
                    </div>
                    <div class="user-info">
                        <div class="user-name">Dr. Smith <span id="sessionDisplayName">(Session: Loading...)</span></div>
                        <div class="user-role">General Practitioner</div>
                    </div>
                </div>
            </div>
        </div>
        <div class="right-container">
            <div class="right-top-container">
                <div class="chat-container">
                    <div class="welcome-section" id="welcomeSection">
                        <svg width="31" height="30" viewBox="0 0 31 30" fill="none" xmlns="http://www.w3.org/2000/svg">
                            <path d="M12.0129 2.67236C12.9723 -0.890788 18.0277 -0.890787 18.9871 2.67236L20.3219 7.62994C20.6565 8.87273 21.6273 9.8435 22.8701 10.1781L27.8276 11.5129C31.3908 12.4723 31.3908 17.5277 27.8276 18.4871L22.8701 19.8219C21.6273 20.1565 20.6565 21.1273 20.3219 22.3701L18.9871 27.3276C18.0277 30.8908 12.9723 30.8908 12.0129 27.3276L10.6781 22.3701C10.3435 21.1273 9.37273 20.1565 8.12994 19.8219L3.17236 18.4871C-0.390788 17.5277 -0.390787 12.4723 3.17236 11.5129L8.12994 10.1781C9.37273 9.8435 10.3435 8.87273 10.6781 7.62994L12.0129 2.67236Z" fill="#19B76A"/>
                        </svg>
                        <p>Hello, I'm Dr. Smith <span id="sessionDisplay">(Session: Loading...)</span>!<br>
                        How can I help you today?</p>
                    </div>
                    <div class="chat-conversation" id="chatConversation">
                        <!-- Messages will be added here dynamically -->
                    </div>
                </div>
            </div>
            <div class="right-bottom-container">
                <div class="input-section">
                    <div class="input-field">
                        <input type="text" placeholder="Type your message..." class="message-input">
                        <input type="file" id="pdfFileInput" accept=".pdf" style="display: none;">
                    </div>
                    <div class="button-group">
                        <button class="pdf-btn" id="pdfUploadBtn">
                            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                                <path d="M21.44 11.05L12.25 20.24C11.1242 21.3658 9.59722 21.9983 8.005 21.9983C6.41278 21.9983 4.8858 21.3658 3.76 20.24C2.6342 19.1142 2.0017 17.5872 2.0017 15.995C2.0017 14.4028 2.6342 12.8758 3.76 11.75L12.95 2.56C13.7006 1.80944 14.7186 1.38787 15.79 1.38787C16.8614 1.38787 17.8794 1.80944 18.63 2.56C19.3806 3.31056 19.8021 4.32856 19.8021 5.4C19.8021 6.47144 19.3806 7.48944 18.63 8.24L9.41 17.46C9.03475 17.8352 8.53125 18.0499 8.005 18.0499C7.47875 18.0499 6.97525 17.8352 6.6 17.46C6.22475 17.0848 6.01005 16.5813 6.01005 16.055C6.01005 15.5287 6.22475 15.0252 6.6 14.65L15.07 6.18" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                            </svg>
                        </button>
                        <button class="send-btn">
                            <svg width="16" height="16" viewBox="0 0 25 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                                <path d="M15.9006 8.95457L10.2934 14.4616M10.2934 14.4616L14.8101 22.1449C15.2412 22.8782 16.3329 22.7726 16.6154 21.9703L23.341 2.87133C23.6137 2.09687 22.8885 1.34195 22.1037 1.58338L2.16397 7.71785C1.33369 7.97328 1.20155 9.09305 1.94956 9.53473L10.2934 14.4616Z" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                            </svg>
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // ===========================================
        // COMPREHENSIVE API INTEGRATION SYSTEM
        // ===========================================
        
        // API Configuration
        const API_CONFIG = {
            baseURL: window.location.hostname === 'localhost' 
                ? 'http://localhost:8080/proxy/blood-diagnostic-bot-7b4wpufaoq-el.a.run.app'
                : '/.netlify/functions/proxy',
            apiKey: 'healthcare-llm-gateway-api-key',
            endpoints: {
                // Health endpoints
                health: {
                    basic: '/api/v1/health/',
                    detailed: '/api/v1/health/detailed',
                    ready: '/api/v1/health/ready',
                    live: '/api/v1/health/live'
                },
                // Session management
                sessions: {
                    create: '/api/v1/chat/sessions',
                    list: '/api/v1/chat/sessions',
                    history: (sessionId) => `/api/v1/chat/sessions/${sessionId}/history`,
                    export: (sessionId) => `/api/v1/chat/sessions/${sessionId}/export/bibliography`
                },
                // Messaging
                messages: {
                    send: (sessionId) => `/api/v1/chat/sessions/${sessionId}/messages`
                },
                // File operations
                files: {
                    uploadReport: '/api/v1/chat/upload/report',
                    uploadDocument: '/api/v1/documents/upload',
                    processDocument: '/api/v1/documents/process',
                    getSources: '/api/v1/documents/sources'
                }
            }
        };

        // Global state management
        let currentSessionId = null;
        let chatHistory = [];
        let userSessions = [];
        let isProcessing = false;

        // ===========================================
        // API SERVICE LAYER
        // ===========================================
        
        class BloodDiagnosticAPI {
            // Health check methods
            static async checkHealth(type = 'basic') {
                try {
                    const response = await fetch(`${API_CONFIG.baseURL}${API_CONFIG.endpoints.health[type]}`, {
                        method: 'GET',
                        headers: { 'X-API-Key': API_CONFIG.apiKey }
                    });
                    return await response.json();
                } catch (error) {
                    console.error(`Health check failed (${type}):`, error);
                    throw error;
                }
            }

            // Session management methods
            static async createSession(userId = 'user_123', title = 'New Session', textInput = null, file = null) {
                try {
                    // Use different approaches for localhost vs Netlify
                    if (window.location.hostname === 'localhost') {
                        // Localhost: Use FormData
                        const formData = new FormData();
                        formData.append('user_id', userId);
                        formData.append('title', title);
                        
                        if (textInput) {
                            formData.append('text_input', textInput);
                        }
                        
                        if (file) {
                            formData.append('report_file', file);
                        }

                        const response = await fetch(`${API_CONFIG.baseURL}${API_CONFIG.endpoints.sessions.create}`, {
                            method: 'POST',
                            headers: { 'X-API-Key': API_CONFIG.apiKey },
                            body: formData
                        });

                        if (!response.ok) {
                            const errorText = await response.text();
                            console.error('Session creation API Error Response:', errorText);
                            throw new Error(`HTTP error! status: ${response.status} - ${errorText}`);
                        }

                        const data = await response.json();
                        return data;
                    } else {
                        // Netlify: Use URLSearchParams for application/x-www-form-urlencoded
                        const formData = new URLSearchParams();
                        formData.append('user_id', userId);
                        formData.append('title', title);
                        
                        if (textInput) {
                            formData.append('text_input', textInput);
                        }
                        
                        if (file) {
                            formData.append('report_file', file);
                        }

                        const response = await fetch(`${API_CONFIG.baseURL}${API_CONFIG.endpoints.sessions.create}`, {
                            method: 'POST',
                            headers: { 
                                'X-API-Key': API_CONFIG.apiKey,
                                'Content-Type': 'application/x-www-form-urlencoded'
                            },
                            body: formData
                        });

                        if (!response.ok) {
                            const errorText = await response.text();
                            console.error('Session creation API Error Response:', errorText);
                            throw new Error(`HTTP error! status: ${response.status} - ${errorText}`);
                        }

                        const data = await response.json();
                        return data;
                    }
                } catch (error) {
                    console.error('Error creating session:', error);
                    throw error;
                }
            }

            static async listSessions(userId = 'user_123', page = 1, limit = 50, sort = 'date_desc', filterUrgent = false) {
                try {
                    const params = new URLSearchParams({
                        user_id: userId,
                        page: page,
                        limit: limit,
                        sort: sort,
                        filter_urgent: filterUrgent
                    });

                    const response = await fetch(`${API_CONFIG.baseURL}${API_CONFIG.endpoints.sessions.list}?${params}`, {
                        method: 'GET',
                        headers: { 'X-API-Key': API_CONFIG.apiKey }
                    });

                    return await response.json();
                } catch (error) {
                    console.error('Error listing sessions:', error);
                    throw error;
                }
            }

            static async getSessionHistory(sessionId) {
                try {
                    const response = await fetch(`${API_CONFIG.baseURL}${API_CONFIG.endpoints.sessions.history(sessionId)}`, {
                        method: 'GET',
                        headers: { 'X-API-Key': API_CONFIG.apiKey }
                    });

                    return await response.json();
                } catch (error) {
                    console.error('Error getting session history:', error);
                    throw error;
                }
            }

            // Messaging methods
            static async sendMessage(sessionId, content, metadata = {}) {
                try {
                    const formData = new FormData();
                    formData.append('content', content);
                    formData.append('metadata', JSON.stringify(metadata));

                    const response = await fetch(`${API_CONFIG.baseURL}${API_CONFIG.endpoints.messages.send(sessionId)}`, {
                        method: 'POST',
                        headers: { 'X-API-Key': API_CONFIG.apiKey },
                        body: formData
                    });

                    if (!response.ok) {
                        throw new Error(`HTTP error! status: ${response.status}`);
                    }

                    return await response.json();
                } catch (error) {
                    console.error('Error sending message:', error);
                    throw error;
                }
            }

            // File upload methods
            static async uploadReport(userId, file, textInput = null) {
                try {
                    // Validate file
                    if (!file) {
                        throw new Error('No file provided');
                    }
                    
                    if (file.type !== 'application/pdf') {
                        throw new Error('Only PDF files are supported');
                    }
                    
                    if (file.size > 10 * 1024 * 1024) { // 10MB limit
                        throw new Error('File too large. Maximum size is 10MB');
                    }

                    console.log('📤 Uploading file:', file.name, 'Size:', file.size, 'Type:', file.type);

                    // Use different approaches for localhost vs Netlify
                    if (window.location.hostname === 'localhost') {
                        // Localhost: Use FormData
                        const formData = new FormData();
                        formData.append('user_id', userId);
                        formData.append('file', file);
                        
                        if (textInput) {
                            formData.append('text_input', textInput);
                        }

                        const response = await fetch(`${API_CONFIG.baseURL}${API_CONFIG.endpoints.files.uploadReport}`, {
                            method: 'POST',
                            headers: { 'X-API-Key': API_CONFIG.apiKey },
                            body: formData
                        });

                        console.log('📡 Upload response status:', response.status);

                        if (!response.ok) {
                            const errorText = await response.text();
                            console.error('Upload API Error Response:', errorText);
                            throw new Error(`HTTP error! status: ${response.status} - ${errorText}`);
                        }

                        const data = await response.json();
                        console.log('✅ Upload successful:', data);
                        return data;
                    } else {
                        // Netlify: Convert to base64 and send as JSON
                        const base64File = await this.fileToBase64(file);
                        
                        const requestBody = {
                            user_id: userId,
                            file: base64File,
                            filename: file.name,
                            content_type: file.type
                        };
                        
                        if (textInput) {
                            requestBody.text_input = textInput;
                        }

                        const response = await fetch(`${API_CONFIG.baseURL}${API_CONFIG.endpoints.files.uploadReport}`, {
                            method: 'POST',
                            headers: { 
                                'X-API-Key': API_CONFIG.apiKey,
                                'Content-Type': 'application/json'
                            },
                            body: JSON.stringify(requestBody)
                        });

                        console.log('📡 Upload response status:', response.status);

                        if (!response.ok) {
                            const errorText = await response.text();
                            console.error('Upload API Error Response:', errorText);
                            throw new Error(`HTTP error! status: ${response.status} - ${errorText}`);
                        }

                        const data = await response.json();
                        console.log('✅ Upload successful:', data);
                        return data;
                    }
                } catch (error) {
                    console.error('Error uploading report:', error);
                    throw error;
                }
            }

            // Helper method to convert file to base64
            static fileToBase64(file) {
                return new Promise((resolve, reject) => {
                    const reader = new FileReader();
                    reader.readAsDataURL(file);
                    reader.onload = () => {
                        // Remove the data:application/pdf;base64, prefix
                        const base64 = reader.result.split(',')[1];
                        resolve(base64);
                    };
                    reader.onerror = error => reject(error);
                });
            }

            // Export methods
            static async exportBibliography(sessionId, format = 'json') {
                try {
                    const response = await fetch(`${API_CONFIG.baseURL}${API_CONFIG.endpoints.sessions.export(sessionId)}?format=${format}`, {
                        method: 'GET',
                        headers: { 'X-API-Key': API_CONFIG.apiKey }
                    });

                    return await response.json();
                } catch (error) {
                    console.error('Error exporting bibliography:', error);
                    throw error;
                }
            }
        }

        // ===========================================
        // SESSION MANAGEMENT
        // ===========================================
        
        async function createSession() {
            try {
                const data = await BloodDiagnosticAPI.createSession('user_123', 'Blood Diagnostic Session');
                currentSessionId = data.data?.session_id || data.data?.id;
                console.log('✅ Session created:', currentSessionId);
                updateSessionDisplay(); // Update the display with real session ID
                return currentSessionId;
            } catch (error) {
                console.error('❌ Error creating session:', error);
                showError('Failed to create session. Please try again.');
                return null;
            }
        }

        // ===========================================
        // MESSAGING SYSTEM
        // ===========================================
        
        async function sendMessageToAPI(message, messageType = 'clinical_assessment') {
            try {
                // Create session if we don't have one
                if (!currentSessionId) {
                    await createSession();
                }
                
                if (!currentSessionId) {
                    throw new Error('Failed to create session');
                }

                const metadata = {
                    type: messageType,
                    priority: 'normal'
                };

                const response = await BloodDiagnosticAPI.sendMessage(currentSessionId, message, metadata);
                return response;
            } catch (error) {
                console.error('❌ Error sending message:', error);
                showError('Failed to send message. Please try again.');
                return null;
            }
        }

        // Add message to chat with loading state support
        function addMessageToChat(message, sender, isLoading = false) {
            const chatConversation = document.getElementById('chatConversation');
            const messageId = 'msg_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
            
            const messageDiv = document.createElement('div');
            messageDiv.className = `message ${sender}-message`;
            messageDiv.id = messageId;
            
            if (isLoading) {
                messageDiv.innerHTML = `
                    <div class="message-content">
                        <div class="loading-dots">
                            <span></span><span></span><span></span>
                        </div>
                    </div>
                `;
            } else {
                messageDiv.innerHTML = `
                    <div class="message-content">
                        <p>${message}</p>
                    </div>
                `;
            }
            
            chatConversation.appendChild(messageDiv);
            chatConversation.scrollTop = chatConversation.scrollHeight;
            
            return messageId;
        }

        // Remove message from chat
        function removeMessageFromChat(messageId) {
            const messageElement = document.getElementById(messageId);
            if (messageElement) {
                messageElement.remove();
            }
        }

        // Auto-refresh disabled for better user experience
        // if (window.location.hostname === 'localhost' || window.location.hostname === '127.0.0.1') {
        //     // Check for file changes every 2 seconds
        //     setInterval(() => {
        //         fetch(window.location.href, { method: 'HEAD' })
        //             .then(response => {
        //                 if (response.headers.get('last-modified') !== window.lastModified) {
        //                     window.location.reload();
        //                 }
        //             })
        //             .catch(() => {});
        //     }, 2000);
        // }


        // Add basic interactivity
        document.addEventListener('DOMContentLoaded', function() {
            const messageInput = document.querySelector('.message-input');
            const sendBtn = document.querySelector('.send-btn');
            const pdfUploadBtn = document.getElementById('pdfUploadBtn');
            const pdfFileInput = document.getElementById('pdfFileInput');
            const chatHistory = document.querySelector('.chat-history');
            const welcomeSection = document.getElementById('welcomeSection');
            const chatConversation = document.getElementById('chatConversation');

            // Send message functionality with API integration
        // ===========================================
        // MAIN MESSAGE HANDLING
        // ===========================================
        
        async function sendMessage() {
            const message = messageInput.value.trim();
            if (!message || isProcessing) return;

            isProcessing = true;
            
            // Hide welcome section and show chat conversation
            hideWelcomeSection();
            showChatConversation();

            // Add user message to chat
            addMessageToConversation(message, 'user');

            // Only add to chat history if this is the first message in a conversation
            if (!document.querySelector('.chat-item.conversation-item')) {
                addConversationToHistory();
            } else {
                // Update the existing conversation item
                updateConversationInHistory(message);
            }

            // Show loading state
            const loadingId = addMessageToChat('Analyzing your request...', 'assistant', true);

            try {
                // Send to API
                const response = await sendMessageToAPI(message);
                
                if (response && response.success) {
                    // Remove loading message
                    removeMessageFromChat(loadingId);
                    
                    // Process and display API response
                    const responseData = response.data?.content || response.data;
                    let responseText = 'No response received';
                    
                    if (typeof responseData === 'string') {
                        responseText = responseData;
                    } else if (responseData && typeof responseData === 'object') {
                        // Format structured medical response
                        responseText = formatMedicalResponse(responseData);
                    }
                    
                    addMessageToConversation(responseText, 'assistant');
                    
                    // Store in chat history
                    chatHistory.push({
                        user: message,
                        assistant: responseText,
                        timestamp: new Date().toISOString()
                    });
                } else {
                    // Handle API error - show fallback
                    removeMessageFromChat(loadingId);
                    const fallbackResponse = generateFallbackResponse(message);
                    addMessageToConversation(fallbackResponse, 'assistant');
                }
            } catch (error) {
                // Handle error - show fallback
                removeMessageFromChat(loadingId);
                const fallbackResponse = generateFallbackResponse(message);
                addMessageToConversation(fallbackResponse, 'assistant');
            } finally {
                isProcessing = false;
                // Clear input
                messageInput.value = '';
            }
        }

        // ===========================================
        // RESPONSE FORMATTING
        // ===========================================
        
        function formatMedicalResponse(data) {
            let formatted = '';
            
            if (data.summary) {
                formatted += `**Summary:** ${data.summary}\n\n`;
            }
            
            if (data.key_findings && Array.isArray(data.key_findings)) {
                formatted += `**Key Findings:**\n`;
                data.key_findings.forEach(finding => {
                    formatted += `• ${finding}\n`;
                });
                formatted += '\n';
            }
            
            if (data.clinical_impression) {
                formatted += `**Clinical Impression:** ${data.clinical_impression}\n\n`;
            }
            
            if (data.immediate_actions && Array.isArray(data.immediate_actions)) {
                formatted += `**Immediate Actions:**\n`;
                data.immediate_actions.forEach(action => {
                    formatted += `• ${action}\n`;
                });
                formatted += '\n';
            }
            
            if (data.citations && Array.isArray(data.citations)) {
                formatted += `**References:**\n`;
                data.citations.forEach((citation, index) => {
                    formatted += `${index + 1}. ${citation.source}`;
                    if (citation.year) formatted += ` (${citation.year})`;
                    if (citation.link) formatted += ` - [View Source](${citation.link})`;
                    formatted += '\n';
                });
            }
            
            return formatted || 'Analysis completed. Please ask for more specific details.';
        }

        function generateFallbackResponse(message) {
            const responses = [
                "I understand your concern. Let me help you with that.",
                "That's a great question. I'd be happy to assist you with that.",
                "I can see you're looking for medical information. Let me help you with that.",
                "Thank you for reaching out. I'm here to help you with your medical analysis needs.",
                "I understand you need assistance. Let me guide you through the process.",
                "That's an interesting question. I can definitely help you with that.",
                "I'm here to help you with medical diagnosis and analysis. What would you like to know?",
                "I can assist you with patient management and medical analysis. How can I help?"
            ];
            
            // Simple keyword-based responses
            if (message.toLowerCase().includes('blood')) {
                return "I can help you analyze blood test results! For the most accurate analysis, please upload your blood test PDF using the paperclip icon. I can then provide detailed insights and diagnosis recommendations.";
            } else if (message.toLowerCase().includes('patient')) {
                return "I can help you with patient management and analysis. Please provide more details about the specific case or upload relevant medical documents for a comprehensive assessment.";
            } else if (message.toLowerCase().includes('diagnosis')) {
                return "I can assist with medical diagnosis based on symptoms, lab results, and clinical data. Please share the relevant information and I'll provide a detailed analysis.";
            } else {
                return responses[Math.floor(Math.random() * responses.length)];
            }
        }

            function addMessageToConversation(message, sender) {
                const messageDiv = document.createElement('div');
                messageDiv.className = `message ${sender}`;
                
                    messageDiv.innerHTML = `
                        <div class="message-bubble">${message}</div>
                    `;
                
                chatConversation.appendChild(messageDiv);
                
                // Scroll to bottom with smooth animation
                setTimeout(() => {
                    chatConversation.scrollTo({
                        top: chatConversation.scrollHeight,
                        behavior: 'smooth'
                    });
                }, 100);
            }

            function addConversationToHistory() {
                const chatItem = document.createElement('div');
                chatItem.className = 'chat-item conversation-item';
                
                const now = new Date();
                const timeString = now.toLocaleTimeString('en-US', { 
                    hour: 'numeric', 
                    minute: '2-digit',
                    hour12: true 
                });
                
                    chatItem.innerHTML = `
                        <div class="chat-header">
                            <div class="chat-date">Chat Conversation</div>
                        <div class="chat-time">${timeString}</div>
                        </div>
                        <div class="chat-message">Click to view conversation</div>
                    `;
                
                // Remove active class from all existing chat items
                document.querySelectorAll('.chat-item').forEach(item => {
                    item.classList.remove('active');
                });
                
                // Add active class to new chat item
                chatItem.classList.add('active');
                    
                    // Add to top of chat history
                    chatHistory.insertBefore(chatItem, chatHistory.firstChild);
                    
                    // Add click functionality
                    chatItem.addEventListener('click', () => {
                        // Remove active class from all chat items
                        document.querySelectorAll('.chat-item').forEach(item => {
                            item.classList.remove('active');
                        });
                        
                        // Add active class to clicked item
                        chatItem.classList.add('active');
                        
                    // Show the conversation for this chat item
                    showConversationForChatItem(chatItem);
                    });
                
                // Scroll to top
                chatHistory.scrollTop = 0;
                }
                
            function updateConversationInHistory(message) {
                const conversationItem = document.querySelector('.chat-item.conversation-item');
                if (conversationItem) {
                const now = new Date();
                const timeString = now.toLocaleTimeString('en-US', { 
                    hour: 'numeric', 
                    minute: '2-digit',
                    hour12: true 
                });
                
                    conversationItem.querySelector('.chat-time').textContent = timeString;
                    conversationItem.querySelector('.chat-message').textContent = `Last message: ${message.substring(0, 30)}${message.length > 30 ? '...' : ''}`;
                }
            }

            function generateAIResponse(userMessage) {
                // Check if user has already uploaded a PDF in this conversation
                const hasUploadedPDF = document.querySelector('.pdf-document-card');
                
                const responses = [
                    "I understand your concern. Let me help you with that.",
                    "That's a great question. I'd be happy to assist you with that.",
                    "I can see you're looking for medical information. Let me help you with that.",
                    "Thank you for reaching out. I'm here to help you with your medical analysis needs.",
                    "I understand you need assistance. Let me guide you through the process.",
                    "That's an interesting question. I can definitely help you with that.",
                    "I'm here to help you with medical diagnosis and analysis. What would you like to know?",
                    "I can assist you with patient management and medical analysis. How can I help?"
                ];
                
                // Simple keyword-based responses
                if (userMessage.toLowerCase().includes('blood')) {
                    if (hasUploadedPDF) {
                        return "I can help you analyze blood test results. I see you've already uploaded a PDF - I can provide detailed analysis based on those results, or you can ask me specific questions about the values.";
                    } else {
                        return "I can help you analyze blood test results! For the most accurate analysis, please upload your blood test PDF using the paperclip icon. I can then provide detailed insights and diagnosis recommendations.";
                    }
                } else if (userMessage.toLowerCase().includes('patient')) {
                    if (hasUploadedPDF) {
                        return "I'm here to help with patient management. I can see you've uploaded test results - I can provide comprehensive analysis and recommendations based on those findings.";
                    } else {
                        return "I'm here to help with patient management! To provide the most accurate analysis, please upload the patient's test results PDF using the paperclip icon. I can then give you detailed insights and treatment recommendations.";
                    }
                } else if (userMessage.toLowerCase().includes('diagnosis')) {
                    if (hasUploadedPDF) {
                        return "I can assist with the diagnosis process. I see you've uploaded test results - I can provide detailed diagnostic analysis based on those findings, or you can ask me specific questions about the results.";
                    } else {
                        return "I can assist with the diagnosis process! For comprehensive diagnostic analysis, please upload the patient's test results PDF using the paperclip icon. I can then provide detailed diagnosis recommendations and supporting evidence.";
                    }
                } else {
                    // General response with PDF upload guidance
                    if (hasUploadedPDF) {
                        return responses[Math.floor(Math.random() * responses.length)] + " I can see you've uploaded test results - feel free to ask me any questions about the analysis or upload additional files if needed.";
                    } else {
                        return responses[Math.floor(Math.random() * responses.length)] + " For detailed medical analysis, I recommend uploading your test results PDF using the paperclip icon. I can then provide comprehensive insights and recommendations.";
                    }
                }
            }

            function showConversationForChatItem(chatItem) {
                // Show the current conversation
                    showChatConversation();
            }

            // Event listeners
            sendBtn.addEventListener('click', sendMessage);
            
            messageInput.addEventListener('keypress', function(e) {
                if (e.key === 'Enter') {
                    sendMessage();
                }
            });


            // PDF upload functionality
            pdfUploadBtn.addEventListener('click', () => {
                pdfFileInput.click();
            });

            pdfFileInput.addEventListener('change', function(e) {
                console.log('PDF file selected');
                const file = e.target.files[0];
                if (file && file.type === 'application/pdf') {
                    console.log('Valid PDF file:', file.name);
                    processPDFUpload(file);
                } else {
                    console.log('Invalid file type:', file ? file.type : 'no file');
                    alert('Please select a valid PDF file.');
                }
            });

        // ===========================================
        // FILE UPLOAD SYSTEM
        // ===========================================
        
        async function processPDFUpload(file) {
            if (isProcessing) return;
            
            console.log('📄 PDF upload started:', file.name);
            isProcessing = true;
            
            // Hide welcome section and show chat conversation
            hideWelcomeSection();
            showChatConversation();
            
            // If no conversation exists, create one
            if (!document.querySelector('.chat-item.conversation-item')) {
                addConversationToHistory();
            }
            
            // Add PDF document card to current conversation
            addMessageToConversation(`
                <div class="pdf-document-card">
                    <div class="pdf-file-name">${file.name}</div>
                    <div class="pdf-icon-container">
                        <div class="pdf-icon">PDF</div>
                    </div>
                </div>
            `, 'user');
            
            // Show processing message
            const processingId = showAnimatedProcessingMessage();
            
            try {
                // Upload file to API
                const response = await BloodDiagnosticAPI.uploadReport('user_123', file, 'Blood test report analysis');
                
                if (response && response.success) {
                    // Hide processing message
                    hideProcessingMessage(processingId);
                    
                    // Get session ID from upload response
                    const sessionId = response.data?.session_id || response.data?.id;
                    if (sessionId) {
                        currentSessionId = sessionId;
                        console.log('✅ PDF uploaded, session created:', sessionId);
                        updateSessionDisplay(); // Update the display with real session ID
                    }
                    
                    // Show analysis results
                    const analysisData = response.data?.content || response.data;
                    let analysisText = 'PDF analysis completed successfully.';
                    
                    if (analysisData && typeof analysisData === 'object') {
                        analysisText = formatMedicalResponse(analysisData);
                    } else if (typeof analysisData === 'string') {
                        analysisText = analysisData;
                    }
                    
                    addMessageToConversation(analysisText, 'assistant');
                    
                } else {
                    // Handle upload error
                    hideProcessingMessage(processingId);
                    addMessageToConversation('PDF upload failed. Please try again or contact support.', 'assistant');
                }
                
            } catch (error) {
                console.error('❌ PDF upload error:', error);
                hideProcessingMessage(processingId);
                
                // Use improved error handling
                const errorMessage = handleAPIError(error, 'PDF upload');
                addMessageToConversation(`❌ ${errorMessage}`, 'assistant');
            } finally {
                isProcessing = false;
            }
        }

            function showAnimatedProcessingMessage() {
                const processingId = 'processing-' + Date.now();
                addMessageToConversation(`
                    <div id="${processingId}" class="analyzing-text">
                        Analyzing
                        <div class="processing-dots">
                            <span class="dot"></span>
                            <span class="dot"></span>
                            <span class="dot"></span>
                        </div>
                    </div>
                `, 'assistant');
            }

            function hideProcessingMessage() {
                const processingMessage = document.querySelector('.analyzing-text');
                if (processingMessage) {
                    processingMessage.style.transition = 'all 0.3s ease';
                    processingMessage.style.opacity = '0';
                    processingMessage.style.transform = 'translateY(-10px)';
                    setTimeout(() => {
                        // Find the parent message div and remove it
                        const messageDiv = processingMessage.closest('.message.assistant');
                        if (messageDiv) {
                            messageDiv.remove();
                        }
                    }, 300);
                }
            }

            // Detailed Diagnosis Chat Functions
            function showDetailedDiagnosis(diagnosisData) {
                // Add user message asking for details
                addMessageToConversation(`Tell me more about ${diagnosisData.name}`, 'user');
                
                // Add detailed diagnosis as assistant message
                setTimeout(() => {
                    addMessageToConversation(`
                        <div class="detailed-diagnosis">
                            <div class="diagnosis-header">
                                <div class="diagnosis-rank-circle">
                                    <div class="rank-number">${diagnosisData.rank}</div>
                                    <h4 class="diagnosis-title">${diagnosisData.name}</h4>
                    </div>
                                <span class="confidence-badge">${diagnosisData.confidence}% Confidence</span>
                                <div class="progress-wrapper">
                                    <div class="progress-label">
                                        <span class="progress-label-text">Confidence</span>
                                        <span class="progress-label-value">${diagnosisData.confidence}%</span>
                                    </div>
                                    <div class="progress-bar-container">
                                        <div class="progress-bar" style="width: ${diagnosisData.confidence}%"></div>
                                    </div>
                                </div>
                                <p class="diagnosis-description">${diagnosisData.description}</p>
                            </div>
                            <div class="diagnosis-details">
                                <div class="detail-section">
                                    <div class="detail-card">
                                        <div class="card-header">
                                            <div class="card-icon" style="background: #19b76a; border-radius: 50%;"></div>
                                            <h5 class="card-title">Supporting Lab Values</h5>
                                        </div>
                                        <div class="badge-container">
                                            ${diagnosisData.supportingLabs.map(lab => `<span class="badge">${lab}</span>`).join('')}
                                        </div>
                                    </div>
                                    <div class="detail-card danger">
                                        <div class="card-header">
                                            <svg class="card-icon" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                                <path d="m21.73 18-8-14a2 2 0 0 0-3.48 0l-8 14A2 2 0 0 0 4 21h16a2 2 0 0 0 1.73-3"></path>
                                                <path d="M12 9v4"></path>
                                                <path d="M12 17h.01"></path>
                                            </svg>
                                            <h5 class="card-title danger">Red Flags</h5>
                                        </div>
                                        <div class="space-y-4">
                                            ${diagnosisData.redFlags.map(flag => `
                                                <div class="red-flag-item">
                                                    <div class="red-flag-dot"></div>
                                                    <span class="red-flag-text">${flag}</span>
                                                </div>
                                            `).join('')}
                                        </div>
                                    </div>
                                </div>
                                <div class="detail-section">
                                    <div class="detail-card success">
                                        <div class="card-header">
                                            <div class="card-icon" style="background: #059669; border-radius: 50%;"></div>
                                            <h5 class="card-title success">Recommended Next Steps</h5>
                                        </div>
                                        <div class="space-y-5">
                                            ${diagnosisData.nextSteps.map((step, index) => `
                                                <div class="step-item">
                                                    <div class="step-number">
                                                        <span>${index + 1}</span>
                                                    </div>
                                                    <p class="step-text">${step}</p>
                                                </div>
                                            `).join('')}
                                        </div>
                                    </div>
                                </div>
                                <div class="evidence-section">
                                    <div class="detail-card">
                                        <div class="card-header">
                                            <svg class="card-icon" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                                <path d="M15 3h6v6"></path>
                                                <path d="M10 14 21 3"></path>
                                                <path d="M18 13v6a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V8a2 2 0 0 1 2-2h6"></path>
                                            </svg>
                                            <h5 class="card-title">Evidence & Citations</h5>
                                        </div>
                                        <div class="evidence-grid">
                                            ${diagnosisData.evidence.map(evidence => `
                                                <div class="evidence-card">
                                                    <div class="evidence-header">
                                                        <span class="evidence-badge">${evidence.level}</span>
                                                        <a href="${evidence.url}" target="_blank" rel="noopener noreferrer">
                                                            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                                                <path d="M15 3h6v6"></path>
                                                                <path d="M10 14 21 3"></path>
                                                                <path d="M18 13v6a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V8a2 2 0 0 1 2-2h6"></path>
                                                            </svg>
                                                        </a>
                                                    </div>
                                                    <h6 class="evidence-title">${evidence.title}</h6>
                                                    <p class="evidence-source">${evidence.source}</p>
                                                    <blockquote class="evidence-quote">"${evidence.quote}"</blockquote>
                                                </div>
                                            `).join('')}
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    `, 'assistant');
                }, 500);
            }

            // Add click handlers to diagnosis cards
            function addDiagnosisClickHandlers() {
                setTimeout(() => {
                    const diagnosisCards = document.querySelectorAll('.diagnosis-card');
                    diagnosisCards.forEach(card => {
                        card.style.cursor = 'pointer';
                        card.addEventListener('click', function() {
                            const rank = this.querySelector('.diagnosis-rank').textContent;
                            const name = this.querySelector('.diagnosis-name').textContent;
                            const confidence = this.querySelector('.confidence-score').textContent.replace('%', '');
                            
                            // Get diagnosis data based on the card clicked
                            const diagnosisData = getDiagnosisData(rank, name, confidence);
                            showDetailedDiagnosis(diagnosisData);
                        });
                    });
                }, 2000);
            }

            function getDiagnosisData(rank, name, confidence) {
                const diagnosisData = {
                    '1': {
                        rank: 1,
                        name: 'Type 2 Diabetes Mellitus',
                        confidence: 85,
                        description: 'Significantly elevated glucose (180 mg/dL) and HbA1c (8.2%) with supporting metabolic markers consistent with diabetes diagnosis.',
                        supportingLabs: ['Glucose', 'HbA1c', 'Metabolic Panel'],
                        redFlags: ['Severe hyperglycemia', 'Poor glycemic control'],
                        nextSteps: [
                            'Start metformin therapy',
                            'Implement lifestyle modifications',
                            'Schedule endocrinology consultation',
                            'Monitor blood glucose regularly'
                        ],
                        evidence: [
                            {
                                level: 'Level I',
                                title: 'Standards of Medical Care in Diabetes',
                                source: 'ADA Guidelines • 2024',
                                quote: 'HbA1c ≥6.5% is diagnostic for diabetes when performed in an appropriately certified laboratory.',
                                url: 'https://diabetesjournals.org/care'
                            }
                        ]
                    },
                    '2': {
                        rank: 2,
                        name: 'Mild Hyperlipidemia',
                        confidence: 60,
                        description: 'Elevated total cholesterol (240 mg/dL) and LDL (165 mg/dL) with low HDL (35 mg/dL) indicating lipid metabolism disorder.',
                        supportingLabs: ['Total Cholesterol', 'LDL', 'HDL'],
                        redFlags: ['High cardiovascular risk'],
                        nextSteps: [
                            'Start statin therapy',
                            'Dietary counseling',
                            'Exercise program',
                            'Follow-up lipid panel in 3 months'
                        ],
                        evidence: [
                            {
                                level: 'Level I',
                                title: '2018 AHA/ACC/AACVPR/AAPA/ABC/ACPM/ADA/AGS/APhA/ASPC/NLA/PCNA Guideline',
                                source: 'AHA Guidelines • 2018',
                                quote: 'High-intensity statin therapy is recommended for primary prevention in patients with LDL-C ≥190 mg/dL.',
                                url: 'https://www.ahajournals.org'
                            }
                        ]
                    },
                    '3': {
                        rank: 3,
                        name: 'Cardiovascular Risk',
                        confidence: 30,
                        description: 'Combined diabetes and dyslipidemia increases cardiovascular risk. Requires comprehensive management and monitoring.',
                        supportingLabs: ['Glucose', 'Cholesterol', 'Blood Pressure'],
                        redFlags: ['Multiple risk factors'],
                        nextSteps: [
                            'Cardiovascular risk assessment',
                            'Blood pressure monitoring',
                            'Lifestyle modifications',
                            'Regular follow-up appointments'
                        ],
                        evidence: [
                            {
                                level: 'Level I',
                                title: '2019 ESC/EAS Guidelines for the Management of Dyslipidaemias',
                                source: 'ESC Guidelines • 2019',
                                quote: 'Patients with diabetes should be considered at very high cardiovascular risk.',
                                url: 'https://www.escardio.org'
                            }
                        ]
                    }
                };
                
                return diagnosisData[rank] || diagnosisData['1'];
            }

            function simulatePDFUpload() {
                console.log('Simulating PDF upload...');
                
                // Add PDF document card to current conversation
                addMessageToConversation(`
                    <div class="pdf-document-card">
                        <div class="pdf-file-name">Blood_Test_Report_John_Smith_2024.pdf</div>
                        <div class="pdf-icon-container">
                            <div class="pdf-icon">PDF</div>
                        </div>
                    </div>
                `, 'user');
                
                // Show animated processing message
                showAnimatedProcessingMessage();
                
                setTimeout(() => {
                    console.log('Processing complete, showing medical data');
                    
                    // Hide processing message first
                    hideProcessingMessage();
                    
                    // Show medical data after a short delay
                    setTimeout(() => {
                        showMedicalDataAsMessages();
                    }, 300);
                }, 3000);
            }

            function showMedicalDataAsMessages() {
                console.log('showMedicalDataAsMessages called');
                
                // Add medical data as assistant messages in the chat (don't clear existing conversation)
                addMessageToConversation('I\'ve analyzed the blood report. Here are the key findings:', 'assistant');
                
                // Add patient information
                setTimeout(() => {
                    addMessageToConversation(`
                        <div class="medical-message">
                            <h4>Patient Information</h4>
                            <div class="patient-info">
                                <div class="info-row">
                                    <span class="info-label">Name:</span>
                                    <span class="info-value">John Smith</span>
                                </div>
                                <div class="info-row">
                                    <span class="info-label">Age:</span>
                                    <span class="info-value">45 years</span>
                                </div>
                                <div class="info-row">
                                    <span class="info-label">Gender:</span>
                                    <span class="info-value">Male</span>
                                </div>
                                <div class="info-row">
                                    <span class="info-label">Date of Birth:</span>
                                    <span class="info-value">March 15, 1979</span>
                                </div>
                                <div class="info-row">
                                    <span class="info-label">Patient ID:</span>
                                    <span class="info-value">#P-2024-001234</span>
                                </div>
                            </div>
                        </div>
                    `, 'assistant');
                }, 500);
                
                // Add diagnosis with cards first
                setTimeout(() => {
                    addMessageToConversation(`
                        <div class="medical-message">
                            <h4>Diagnostic Analysis</h4>
                            <div class="diagnosis-cards-container">
                                <div class="diagnosis-card">
                                    <span class="diagnosis-rank">1</span>
                                    <div class="diagnosis-header-row">
                                        <span class="diagnosis-name">Type 2 Diabetes Mellitus</span>
                                        <div class="diagnosis-confidence">
                                            <span class="confidence-score high-confidence">85%</span>
                                            <span class="confidence-label">Confidence</span>
                                        </div>
                                    </div>
                                    <span class="diagnosis-reasoning">Significantly elevated glucose (180 mg/dL) and HbA1c (8.2%) with supporting metabolic markers consistent with diabetes diagnosis.</span>
                                </div>
                                <div class="diagnosis-card">
                                    <span class="diagnosis-rank">2</span>
                                    <div class="diagnosis-header-row">
                                        <span class="diagnosis-name">Mild Hyperlipidemia</span>
                                        <div class="diagnosis-confidence">
                                            <span class="confidence-score">60%</span>
                                            <span class="confidence-label">Confidence</span>
                                        </div>
                                    </div>
                                    <span class="diagnosis-reasoning">Elevated total cholesterol (240 mg/dL) and LDL (165 mg/dL) with low HDL (35 mg/dL) indicating lipid metabolism disorder.</span>
                                </div>
                                <div class="diagnosis-card">
                                    <span class="diagnosis-rank">3</span>
                                    <div class="diagnosis-header-row">
                                        <span class="diagnosis-name">Cardiovascular Risk</span>
                                        <div class="diagnosis-confidence">
                                            <span class="confidence-score">30%</span>
                                            <span class="confidence-label">Confidence</span>
                                        </div>
                                    </div>
                                    <span class="diagnosis-reasoning">Combined diabetes and dyslipidemia increases cardiovascular risk. Requires comprehensive management and monitoring.</span>
                                </div>
                            </div>
                        </div>
                    `, 'assistant');
                }, 1000);
                
                // Add lab results second
                setTimeout(() => {
                    addMessageToConversation(`
                        <div class="medical-message">
                            <h4>Lab Results <span class="abnormal-count">6 of 6 values abnormal</span></h4>
                            <div class="lab-results">
                                <div class="lab-item">
                                    <span class="lab-name">Glucose (Fasting)</span>
                                    <div class="lab-value-container">
                                        <span class="lab-status-icon high">↗</span>
                                        <span class="lab-value">180 mg/dL</span>
                                    </div>
                                    <span class="lab-normal">Normal: 70-100 mg/dL</span>
                                </div>
                                <div class="lab-item">
                                    <span class="lab-name">HbA1c</span>
                                    <div class="lab-value-container">
                                        <span class="lab-status-icon high">↗</span>
                                        <span class="lab-value">8.2%</span>
                                    </div>
                                    <span class="lab-normal">Normal: <6.0%</span>
                                </div>
                                <div class="lab-item">
                                    <span class="lab-name">Total Cholesterol</span>
                                    <div class="lab-value-container">
                                        <span class="lab-status-icon high">↗</span>
                                        <span class="lab-value">240 mg/dL</span>
                                    </div>
                                    <span class="lab-normal">Normal: <200 mg/dL</span>
                                </div>
                                <div class="lab-item">
                                    <span class="lab-name">LDL Cholesterol</span>
                                    <div class="lab-value-container">
                                        <span class="lab-status-icon high">↗</span>
                                        <span class="lab-value">165 mg/dL</span>
                                    </div>
                                    <span class="lab-normal">Normal: <100 mg/dL</span>
                                </div>
                                <div class="lab-item">
                                    <span class="lab-name">HDL Cholesterol</span>
                                    <div class="lab-value-container">
                                        <span class="lab-status-icon low">↘</span>
                                        <span class="lab-value">35 mg/dL</span>
                                    </div>
                                    <span class="lab-normal">Normal: >40 mg/dL</span>
                                </div>
                                <div class="lab-item">
                                    <span class="lab-name">Triglycerides</span>
                                    <div class="lab-value-container">
                                        <span class="lab-status-icon high">↗</span>
                                        <span class="lab-value">220 mg/dL</span>
                                    </div>
                                    <span class="lab-normal">Normal: <150 mg/dL</span>
                                </div>
                            </div>
                        </div>
                    `, 'assistant');
                }, 1500);
                
                // Add follow-up message
                setTimeout(() => {
                    addMessageToConversation('You can click on any diagnosis card above to see detailed information, or ask me questions about these results.', 'assistant');
                }, 2000);

                // Add click handlers to diagnosis cards
                addDiagnosisClickHandlers();
            }



            function createPatientInfoMessage() {
                return `
                    <div class="medical-message">
                        <h4>Patient Information</h4>
                        <div class="patient-info-content">
                            <p><strong>Name:</strong> Mihir Shah</p>
                            <p><strong>Age:</strong> 54 years old</p>
                            <p><strong>MRN:</strong> MRN-2024-001</p>
                            <p><strong>Gender:</strong> Male</p>
                        </div>
                    </div>
                `;
            }

            function createLabResultsMessage() {
                return `
                    <div class="medical-message">
                        <h4>Lab Results Summary</h4>
                        <div class="lab-summary-content">
                            <p class="abnormal-count">6 of 6 values abnormal</p>
                            <div class="lab-items">
                                <div class="lab-item-result">
                                    <span class="lab-name">Troponin I</span>
                                    <span class="lab-value high">2.5 ng/mL</span>
                                    <span class="lab-severity severe">Severe</span>
                                </div>
                                <div class="lab-item-result">
                                    <span class="lab-name">CK-MB</span>
                                    <span class="lab-value high">8.2 ng/mL</span>
                                    <span class="lab-severity moderate">Moderate</span>
                                </div>
                                <div class="lab-item-result">
                                    <span class="lab-name">BNP</span>
                                    <span class="lab-value high">450 pg/mL</span>
                                    <span class="lab-severity moderate">Moderate</span>
                                </div>
                                <div class="lab-item-result">
                                    <span class="lab-name">Total Cholesterol</span>
                                    <span class="lab-value high">240 mg/dL</span>
                                    <span class="lab-severity mild">Mild</span>
                                </div>
                                <div class="lab-item-result">
                                    <span class="lab-name">HDL Cholesterol</span>
                                    <span class="lab-value low">35 mg/dL</span>
                                    <span class="lab-severity mild">Mild</span>
                                </div>
                                <div class="lab-item-result">
                                    <span class="lab-name">LDL Cholesterol</span>
                                    <span class="lab-value high">165 mg/dL</span>
                                    <span class="lab-severity moderate">Moderate</span>
                                </div>
                            </div>
                        </div>
                    </div>
                `;
            }

            function createDiagnosisMessage() {
                return `
                    <div class="medical-message">
                        <h4>Diagnostic Analysis</h4>
                        <div class="diagnosis-content">
                            <p class="diagnosis-subtitle">3 differential diagnoses ranked by confidence</p>
                            <div class="diagnosis-cards">
                                <div class="diagnosis-card">
                                    <div class="diagnosis-rank">1</div>
                                    <div class="diagnosis-header-row">
                                        <div class="diagnosis-name">Acute Coronary Syndrome</div>
                                        <div class="diagnosis-confidence">
                                            <div class="confidence-score high-confidence">85% confidence</div>
                                        </div>
                                    </div>
                                    <div class="diagnosis-reasoning">Significantly elevated troponin (2.5 ng/mL) with supporting cardiac biomarkers and clinical presentation consistent with acute myocardial injury.</div>
                                </div>
                                <div class="diagnosis-card">
                                    <div class="diagnosis-rank">2</div>
                                    <div class="diagnosis-header-row">
                                        <div class="diagnosis-name">Myocarditis</div>
                                        <div class="diagnosis-confidence">
                                            <div class="confidence-score">60% confidence</div>
                                        </div>
                                    </div>
                                    <div class="diagnosis-reasoning">Troponin elevation in younger patient with possible viral prodrome. Less likely given age and risk factors but requires exclusion.</div>
                                </div>
                                <div class="diagnosis-card">
                                    <div class="diagnosis-rank">3</div>
                                    <div class="diagnosis-header-row">
                                        <div class="diagnosis-name">Pulmonary Embolism with RV Strain</div>
                                        <div class="diagnosis-confidence">
                                            <div class="confidence-score">30% confidence</div>
                                        </div>
                                    </div>
                                    <div class="diagnosis-reasoning">Troponin can be elevated with right heart strain from massive PE. Consider given tachycardia and dyspnea.</div>
                                </div>
                            </div>
                        </div>
                    </div>
                `;
            }

            function createConsolidatedMedicalMessage() {
                return `
                    <div class="medical-message">
                        <h4>Patient Information</h4>
                        <div class="patient-info">
                            <div class="info-row">
                                <span class="info-label">Name:</span>
                                <span class="info-value">John Smith</span>
                            </div>
                            <div class="info-row">
                                <span class="info-label">Age:</span>
                                <span class="info-value">45 years</span>
                            </div>
                            <div class="info-row">
                                <span class="info-label">Gender:</span>
                                <span class="info-value">Male</span>
                            </div>
                            <div class="info-row">
                                <span class="info-label">Date of Birth:</span>
                                <span class="info-value">March 15, 1979</span>
                            </div>
                            <div class="info-row">
                                <span class="info-label">Patient ID:</span>
                                <span class="info-value">#P-2024-001234</span>
                            </div>
                        </div>
                    </div>
                    
                    <div class="medical-message">
                        <h4>Lab Results Summary</h4>
                        <div class="lab-results">
                            <div class="lab-item critical">
                                <span class="lab-name">Glucose (Fasting)</span>
                                <span class="lab-value">180 mg/dL</span>
                                <span class="lab-status">High</span>
                            </div>
                            <div class="lab-item critical">
                                <span class="lab-name">HbA1c</span>
                                <span class="lab-value">8.2%</span>
                                <span class="lab-status">High</span>
                            </div>
                            <div class="lab-item normal">
                                <span class="lab-name">Total Cholesterol</span>
                                <span class="lab-value">195 mg/dL</span>
                                <span class="lab-status">Normal</span>
                            </div>
                            <div class="lab-item warning">
                                <span class="lab-name">LDL Cholesterol</span>
                                <span class="lab-value">135 mg/dL</span>
                                <span class="lab-status">Borderline</span>
                            </div>
                            <div class="lab-item normal">
                                <span class="lab-name">HDL Cholesterol</span>
                                <span class="lab-value">45 mg/dL</span>
                                <span class="lab-status">Normal</span>
                            </div>
                        </div>
                    </div>
                    
                    <div class="medical-message">
                        <h4>Diagnostic Analysis</h4>
                        <div class="diagnosis-content">
                            <div class="diagnosis-item">
                                <span class="diagnosis-label">Primary Diagnosis:</span>
                                <span class="diagnosis-value">Type 2 Diabetes Mellitus</span>
                            </div>
                            <div class="diagnosis-item">
                                <span class="diagnosis-label">Secondary Findings:</span>
                                <span class="diagnosis-value">Mild Hyperlipidemia</span>
                            </div>
                            <div class="diagnosis-item">
                                <span class="diagnosis-label">Risk Assessment:</span>
                                <span class="diagnosis-value">Moderate cardiovascular risk</span>
                            </div>
                            <div class="diagnosis-item">
                                <span class="diagnosis-label">Recommendations:</span>
                                <span class="diagnosis-value">Lifestyle modifications, medication review, follow-up in 3 months</span>
                            </div>
                        </div>
                    </div>
                `;
            }

            // Hide welcome section only when there are chat messages
            function hideWelcomeSection() {
                welcomeSection.style.display = 'none';
            }

            function showWelcomeSection() {
                welcomeSection.style.display = 'flex';
            }

            function showChatConversation() {
                if (chatConversation) {
                    chatConversation.classList.add('active');
                }
            }

            // Chat item click functionality
            chatHistory.addEventListener('click', function(e) {
                const chatItem = e.target.closest('.chat-item');
                if (chatItem) {
                    // Remove active class from all chat items
                    document.querySelectorAll('.chat-item').forEach(item => {
                        item.classList.remove('active');
                    });
                    
                    // Add active class to clicked item
                    chatItem.classList.add('active');
                    
                    // Show the conversation
                    showChatConversation();
                }
            });

            // Auto-generate medical data for testing
            setTimeout(() => {
                showWelcomeSection();
            }, 500);

        });

        // ===========================================
        // ERROR HANDLING & UTILITIES
        // ===========================================
        
        function showError(message, details = null) {
            console.error('❌ Error:', message, details);
            
            // Create error notification
            const errorDiv = document.createElement('div');
            errorDiv.className = 'error-notification';
            errorDiv.style.cssText = `
                position: fixed;
                top: 20px;
                right: 20px;
                background: #fee2e2;
                color: #dc2626;
                padding: 12px 16px;
                border-radius: 8px;
                border: 1px solid #fecaca;
                box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
                z-index: 1000;
                max-width: 350px;
                font-size: 14px;
                line-height: 1.4;
            `;
            
            let errorContent = message;
            if (details) {
                errorContent += `<br><small style="opacity: 0.8;">${details}</small>`;
            }
            errorDiv.innerHTML = errorContent;
            
            document.body.appendChild(errorDiv);
            
            // Auto remove after 8 seconds
            setTimeout(() => {
                if (errorDiv.parentNode) {
                    errorDiv.parentNode.removeChild(errorDiv);
                }
            }, 8000);
        }

        function handleAPIError(error, context = 'API call') {
            console.error(`❌ ${context} error:`, error);
            
            let userMessage = 'An error occurred. Please try again.';
            let details = null;
            
            if (error.message.includes('Failed to fetch')) {
                if (window.location.hostname === 'localhost') {
                    userMessage = 'Connection failed. Please check if the CORS proxy is running.';
                    details = 'Run: python3 cors-proxy.py 8080';
                } else {
                    userMessage = 'Network error. Please check your connection.';
                    details = 'The server may be temporarily unavailable.';
                }
            } else if (error.message.includes('422')) {
                userMessage = 'Invalid request format. Please try a different file.';
                details = 'The file may not be supported or corrupted.';
            } else if (error.message.includes('401')) {
                userMessage = 'Authentication failed. Please refresh the page.';
                details = 'The API key may have expired.';
            } else if (error.message.includes('500')) {
                userMessage = 'Server error. Please try again in a moment.';
                details = 'The server is experiencing issues.';
            } else if (error.message.includes('CORS')) {
                userMessage = 'CORS error. Please try refreshing the page.';
                details = 'Cross-origin request blocked.';
            }
            
            showError(userMessage, details);
            return userMessage;
        }

        function showSuccess(message) {
            console.log('✅ Success:', message);
            
            // Create success notification
            const successDiv = document.createElement('div');
            successDiv.className = 'success-notification';
            successDiv.style.cssText = `
                position: fixed;
                top: 20px;
                right: 20px;
                background: #d1fae5;
                color: #059669;
                padding: 12px 16px;
                border-radius: 8px;
                border: 1px solid #a7f3d0;
                box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
                z-index: 1000;
                max-width: 300px;
                font-size: 14px;
            `;
            successDiv.textContent = message;
            
            document.body.appendChild(successDiv);
            
            // Auto remove after 3 seconds
            setTimeout(() => {
                if (successDiv.parentNode) {
                    successDiv.parentNode.removeChild(successDiv);
                }
            }, 3000);
        }

        // ===========================================
        // CONNECTION MANAGEMENT
        // ===========================================
        
        let connectionStatus = 'unknown';
        let retryCount = 0;
        const maxRetries = 3;

        function updateConnectionStatus(status, message) {
            const statusElement = document.getElementById('connectionStatus');
            if (statusElement) {
                statusElement.className = `connection-status ${status}`;
                statusElement.textContent = message;
            }
        }

        async function checkConnection() {
            try {
                const health = await BloodDiagnosticAPI.checkHealth('basic');
                connectionStatus = 'connected';
                retryCount = 0;
                console.log('✅ API Health Check:', health);
                updateConnectionStatus('connected', 'Connected');
                showSuccess('Connected to Blood Diagnostic API');
                return true;
            } catch (error) {
                connectionStatus = 'disconnected';
                console.warn('⚠️ API Health Check failed:', error);
                
                if (retryCount < maxRetries) {
                    retryCount++;
                    console.log(`🔄 Retrying connection (${retryCount}/${maxRetries})...`);
                    updateConnectionStatus('unknown', `Retrying... (${retryCount}/${maxRetries})`);
                    setTimeout(checkConnection, 2000 * retryCount); // Exponential backoff
                } else {
                    updateConnectionStatus('disconnected', 'Disconnected');
                    handleAPIError(error, 'API connection');
                }
                return false;
            }
        }

        // ===========================================
        // SESSION ID MANAGEMENT
        // ===========================================
        
        function generateSessionId() {
            // Generate a short, user-friendly session ID
            const timestamp = Date.now().toString(36);
            const random = Math.random().toString(36).substr(2, 5);
            return `S${timestamp}${random}`.toUpperCase();
        }
        
        function updateSessionDisplay() {
            const sessionDisplay = document.getElementById('sessionDisplay');
            const sessionDisplayName = document.getElementById('sessionDisplayName');
            
            let sessionId;
            if (currentSessionId) {
                // Show the actual session ID from API
                sessionId = currentSessionId;
            } else {
                // Show a generated session ID for display
                sessionId = generateSessionId();
            }
            
            if (sessionDisplay) {
                sessionDisplay.textContent = `(Session: ${sessionId})`;
            }
            
            if (sessionDisplayName) {
                sessionDisplayName.textContent = `(Session: ${sessionId})`;
            }
        }

        // ===========================================
        // INITIALIZATION
        // ===========================================
        
        // Initialize the application
        document.addEventListener('DOMContentLoaded', function() {
            console.log('🚀 Blood Diagnostic Tool initialized');
            updateSessionDisplay();
            checkConnection();
        });

        // ===========================================
        // EXPORT FUNCTIONALITY
        // ===========================================
        
        async function exportBibliography(format = 'json') {
            if (!currentSessionId) {
                showError('No active session to export');
                return;
            }

            try {
                const response = await BloodDiagnosticAPI.exportBibliography(currentSessionId, format);
                
                if (response && response.success) {
                    // Download the bibliography
                    const data = response.data;
                    const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
                    const url = URL.createObjectURL(blob);
                    
                    const a = document.createElement('a');
                    a.href = url;
                    a.download = `bibliography_${currentSessionId}.${format}`;
                    document.body.appendChild(a);
                    a.click();
                    document.body.removeChild(a);
                    URL.revokeObjectURL(url);
                    
                    showSuccess('Bibliography exported successfully');
                } else {
                    showError('Failed to export bibliography');
                }
            } catch (error) {
                console.error('❌ Export error:', error);
                showError('Failed to export bibliography');
            }
        }

        // ===========================================
        // SESSION MANAGEMENT
        // ===========================================
        
        async function loadUserSessions() {
            try {
                const response = await BloodDiagnosticAPI.listSessions('user_123');
                
                if (response && response.success) {
                    userSessions = response.data?.sessions || [];
                    updateSessionHistory();
                }
            } catch (error) {
                console.error('❌ Failed to load sessions:', error);
            }
        }

        function updateSessionHistory() {
            const chatHistory = document.querySelector('.chat-history');
            if (!chatHistory || !userSessions.length) return;

            // Clear existing history
            chatHistory.innerHTML = '';

            // Add session header
            const header = document.createElement('div');
            header.className = 'section-header';
            header.innerHTML = '<span class="section-title">Previous Sessions</span>';
            chatHistory.appendChild(header);

            // Add sessions
            userSessions.forEach(session => {
                const sessionDiv = document.createElement('div');
                sessionDiv.className = 'chat-item';
                sessionDiv.innerHTML = `
                    <div class="chat-header">
                        <div class="chat-date">${new Date(session.created_at).toLocaleDateString()}</div>
                        <div class="chat-time">${new Date(session.created_at).toLocaleTimeString()}</div>
                    </div>
                    <div class="chat-message">${session.title || 'Blood Diagnostic Session'}</div>
                `;
                
                sessionDiv.addEventListener('click', () => {
                    loadSession(session.id);
                });
                
                chatHistory.appendChild(sessionDiv);
            });
        }

        async function loadSession(sessionId) {
            try {
                const response = await BloodDiagnosticAPI.getSessionHistory(sessionId);
                
                if (response && response.success) {
                    currentSessionId = sessionId;
                    const history = response.data?.history || [];
                    
                    // Clear current conversation
                    const chatConversation = document.getElementById('chatConversation');
                    if (chatConversation) {
                        chatConversation.innerHTML = '';
                    }
                    
                    // Load conversation history
                    history.forEach(message => {
                        if (message.sender === 'user' || message.sender === 'bot') {
                            addMessageToConversation(message.content, message.sender);
                        }
                    });
                    
                    // Show chat conversation
                    hideWelcomeSection();
                    showChatConversation();
                    
                    showSuccess('Session loaded successfully');
                }
            } catch (error) {
                console.error('❌ Failed to load session:', error);
                showError('Failed to load session');
            }
        }

    </script>
</body>
</html>
